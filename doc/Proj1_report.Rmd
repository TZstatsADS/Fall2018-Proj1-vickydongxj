---
title: "Age and Happiness: Does Gender Make a Difference?"
author: 'Xiaojing Dong UNI: xd2195'
output:
  html_document:
    df_print: paged
---

\  

As Plato said, *all human beings natually desire happiness*, which raises a question about what exactly makes people happy. Do the sources of happiness change with age? Are there gender difference? 

To answer the above questions, let us analyze the HappyDB datasets, "a corpus of 100,000 crowd-sourced happy moments", and try to understand the relationship between age, gender and happiness.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load libraries, echo=FALSE, warning=FALSE, message=FALSE}
packages.used=c("tm", "tidytext", "tidyverse", "ngram", "beeswarm", "RColorBrewer",
                "dplyr", "ggplot2", "reshape2", "wordcloud2", "topicmodels", "scales",
                "gplots")

# check packages that need to be installed.
packages.needed=setdiff(packages.used, 
                        intersect(installed.packages()[,1], 
                                  packages.used))
# install additional packages
if(length(packages.needed)>0){
  install.packages(packages.needed, dependencies = TRUE)
}
# load packages
library(tm)
library(tidytext)
library(tidyverse)
library(ngram)
library(beeswarm)
library(RColorBrewer)
library(dplyr)
library(ggplot2)
library(reshape2)
library(wordcloud2)
library(topicmodels)
library(scales)
library(gplots)
source("../lib/plotstacked.R")
source("../lib/speechFuncs.R")
```

```{r read data, echo=FALSE, warning=FALSE, message=FALSE}
# urlfile<-'https://raw.githubusercontent.com/rit-public/HappyDB/master/happydb/data/cleaned_hm.csv'
# hm_data <- read_csv(urlfile)
urlfile<-'https://raw.githubusercontent.com/rit-public/HappyDB/master/happydb/data/demographic.csv'
demo_data <- read_csv(urlfile)
```

```{r text pre-processing, echo=FALSE, warning=FALSE, message=FALSE}
# # Preliminary cleaning of text
# corpus <- VCorpus(VectorSource(hm_data$cleaned_hm))%>%
#   tm_map(content_transformer(tolower))%>%
#   tm_map(removePunctuation)%>%
#   tm_map(removeNumbers)%>%
#   tm_map(removeWords, character(0))%>%
#   tm_map(stripWhitespace)
# 
# # Stemming words and converting tm object to tidy object
# stemmed <- tm_map(corpus, stemDocument) %>%
#   tidy() %>%
#   select(text)
# 
# # Creating tidy format of the dictionary to be used for completing stems
# dict <- tidy(corpus) %>%
#   select(text) %>%
#   unnest_tokens(dictionary, text)
# 
# # Removing stopwords that don't hold any significant information for our data set
# data("stop_words")
# word <- c("happy","ago","yesterday","lot","today","months","month",
#           "happier","happiest","last","week","past")
# stop_words <- stop_words %>%
#   bind_rows(mutate(tibble(word), lexicon = "updated"))
# 
# # Combining stems and dictionary into the same tibble
# completed <- stemmed %>%
#   mutate(id = row_number()) %>%
#   unnest_tokens(stems, text) %>%
#   bind_cols(dict) %>%
#   anti_join(stop_words, by = c("dictionary" = "word"))
# completed <- completed %>%
#   group_by(stems) %>%
#   count(dictionary) %>%
#   mutate(word = dictionary[which.max(n)]) %>%
#   ungroup() %>%
#   select(stems, word) %>%
#   distinct() %>%
#   right_join(completed) %>%
#   select(-stems)
# 
# # Pasting stem completed individual words into their respective happy moments
# completed <- completed %>%
#   group_by(id) %>%
#   summarise(text = str_c(word, collapse = " ")) %>%
#   ungroup()
# 
# # Keeping a track of the happy moments with their own ID
# hm_data <- hm_data %>%
#   mutate(id = row_number()) %>%
#   inner_join(completed)
# write_csv(hm_data, "../output/processed_moments.csv")
```

```{r combining data, echo=FALSE, warning=FALSE, message=FALSE}
hm_data <- read_csv("../output/processed_moments.csv")
hm_data <- hm_data %>%
  inner_join(demo_data, by = "wid") %>%
  select(wid, original_hm, gender, marital, parenthood, reflection_period,
         age, country, ground_truth_category, text) %>%
  mutate(orig.count = sapply(hm_data$original_hm, wordcount)) %>%
  mutate(count = sapply(hm_data$text, wordcount)) %>%
  filter(gender %in% c("m", "f")) %>%
  filter(marital %in% c("single", "married")) %>%
  filter(parenthood %in% c("n", "y")) %>%
  filter(reflection_period %in% c("24h", "3m")) %>%
  mutate(reflection_period = fct_recode(reflection_period, months_3 = "3m", hours_24 = "24h"))

# Converting age to numeric
hm_data$age <- as.integer(hm_data$age)
hm_data <- hm_data %>% 
  filter(!is.na(age)) %>%
  filter(age <= 150) %>%
  filter(orig.count <= 500)
```


## Word counts of original happy moments

First, let us look at the word counts of original happy moments. 

- According to the boxplot, we can see the female tend to use slightly more words to describe their happy moments than men do. 

- If we compare the number of words across age, then there is no significant difference.

```{r sentence length, echo=FALSE, warning=FALSE, message=FALSE}
ggplot(hm_data, aes(x = gender, y = orig.count)) +
  geom_boxplot(aes(fill = gender)) + 
  coord_cartesian(ylim = c(0, 50)) +
  labs(title = "Distribution of word counts vs Gender")

word.count.means <- hm_data %>%
  group_by(age) %>%
  summarise(avg.word.count = mean(orig.count, na.rm=TRUE), frequency = n())
word.count.means <- melt(word.count.means, measure.vars = c("avg.word.count","frequency"))

ggplot(word.count.means, aes(x = age, y = value)) +
  geom_bar(aes(fill = variable), stat = "identity") +
  facet_grid(variable ~ ., scales = "free_y") +
  labs(title = "Average word counts vs Age")
```

## Topic analysis

Based on the most popular terms and the most salient terms for each topic, we manually assign the hashtag to be **Food, Family, Vacation, School, Emotion, SpecialEvent, People, Work, Pets,** and **Shopping**.

```{r LDA, echo=FALSE, warning=FALSE, message=FALSE}
# Gengerating document-term matrices
docs <- Corpus(VectorSource(hm_data$text))
dtm <- DocumentTermMatrix(docs)
rowTotals <- apply(dtm , 1, sum) # Find the sum of words in each Document
dtm  <- dtm[rowTotals>0, ]
hm_corpus <- hm_data[rowTotals>0, ]

# Setting parameters for Gibbs sampling
burnin <- 4000
iter <- 2000
thin <- 500
seed <- list(2003,5,63,100001,765)
nstart <- 5
best <- TRUE
# Number of topics
k <- 10

# Running LDA using Gibbs sampling
ldaOut <-LDA(dtm, k, method="Gibbs",
             control=list(nstart = nstart, seed = seed, best = best,
                          burnin = burnin, iter = iter, thin = thin))

# Writing out results
# docs to topics
ldaOut.topics <- as.matrix(topics(ldaOut))
write.csv(ldaOut.topics,file=paste("../output/LDAGibbs",k,"DocsToTopics.csv"))
# top terms in each topic
ldaOut.terms <- as.matrix(terms(ldaOut,20))
write.csv(ldaOut.terms,file=paste("../output/LDAGibbs",k,"TopicsToTerms.csv"))
# probabilities associated with each topic assignment
topicProbabilities <- as.data.frame(ldaOut@gamma)
write.csv(topicProbabilities,file=paste("../output/LDAGibbs",k,"TopicProbabilities.csv"))
```

```{r tag, echo=FALSE, warning=FALSE, message=FALSE}
# terms.beta <- ldaOut@beta
# terms.beta <- scale(terms.beta)
# topics.terms <- NULL
# for(i in 1:k){
#   topics.terms <- rbind(topics.terms, ldaOut@terms[order(terms.beta[i,], decreasing = TRUE)[1:7]])
# }
# topics.terms
# ldaOut.terms
```

### Sources of happiness with respect to age

To explore the relationship between age and happiness, let us use heatmap to visualize the weight allocation of each topic with respect to age.

```{r age, echo=FALSE, warning=FALSE, message=FALSE}
topics.hash <- c("Food", "Family", "Vacation", "School", "Emotion", 
                 "SpecialEvent", "People", "Work", "Pets", "Shopping")
hm_corpus$ldatopic <- as.vector(ldaOut.topics)
hm_corpus$ldahash <- topics.hash[ldaOut.topics]
colnames(topicProbabilities) <- topics.hash
hm_corpus_df <- cbind(hm_corpus, topicProbabilities)

par(mar=c(1,1,1,1))
topic.plot <- c(1, 7, 10, 6, 3, 4, 9, 8, 2)
topic.summary <- tbl_df(hm_corpus_df) %>%
  select(age, Food:Shopping) %>%
  group_by(age) %>%
  summarise_all(funs(mean))
topic.summary <- as.data.frame(topic.summary)
rownames(topic.summary) <- topic.summary[,1]

heatmap.2(as.matrix(topic.summary[,topic.plot+1]), 
          scale = "column", dendrogram = "column", Rowv=FALSE,
          col = bluered(100), key=FALSE, 
          cexRow = 0.65, cexCol = 0.8, margins = c(5, 5),
          trace = "none", density.info = "none")
```

- For the teenagers under the age of 20, we can see **School** and **Vacation** are the most important sources of happiness.

- When the young teenagers turn 20, they tend to care more about the leisurement and their social lifes, such as **Special Event**, **People** and **Shopping**.

- For the middle-aged people between 45 and 65, **Work** and **Family** become the most important sources of happiness, while **Food** becomes less important. We can also observe that **School** shows another peak around the age of 45, which may be because their children.

- For the elderly people, **Family** and **Pets** tend to carry more weights, which suggest that the elderly need more companionship.

Moreover, if we look at the weight allocation of each topic with respect to marital status and parenthood, we find that after getting married and/or having a child, **Family**, **Vacation** and **Special Event** appear to make people happier than before.

```{r marital and parenthood, echo=FALSE, warning=FALSE, message=FALSE}
# marital
topic.marital <- tbl_df(hm_corpus_df) %>%
  select(marital, Food:Shopping) %>%
  group_by(marital) %>%
  summarise_all(funs(mean))
topic.marital <- as.data.frame(topic.marital)
rownames(topic.marital) <- topic.marital[,1]

heatmap.2(as.matrix(topic.marital[,topic.plot+1]), 
          scale = "column", dendrogram = "column", Rowv=FALSE, 
          col = alpha(bluered(100),0.6), key=FALSE, 
          cexRow = 0.8, cexCol = 0.8, margins = c(5, 5),
          trace = "none", density.info = "none",
          main = "Topic Allocation vs Marital Status")

# parenthood
topic.parenthood <- tbl_df(hm_corpus_df) %>%
  select(parenthood, Food:Shopping) %>%
  group_by(parenthood) %>%
  summarise_all(funs(mean))
topic.parenthood <- as.data.frame(topic.parenthood)
rownames(topic.parenthood) <- topic.parenthood[,1]

heatmap.2(as.matrix(topic.parenthood[,topic.plot+1]), 
          scale = "column", dendrogram = "column", Rowv=FALSE, 
          col = alpha(bluered(100),0.6), key=FALSE, 
          cexRow = 0.8, cexCol = 0.8, margins = c(5, 5),
          trace = "none", density.info = "none",
          main = "Topic Allocation vs Parenthood")
```

### Are there gender differences?

```{r gender, echo=FALSE, warning=FALSE, message=FALSE}
par(mar=c(1,1,1,1))
topic.plot <- c(9, 2, 8, 3, 4, 7, 6, 10, 1)

# female
topic.female <- tbl_df(hm_corpus_df) %>%
  filter(gender %in% c("f")) %>%
  select(age, Food:Shopping) %>%
  group_by(age) %>%
  summarise_all(funs(mean))
topic.female <- as.data.frame(topic.female)
rownames(topic.female) <- topic.female[,1]

heatmap.2(as.matrix(topic.female[,topic.plot+1]), 
          scale = "column", dendrogram = "none", Rowv=FALSE, Colv=FALSE,
          col = bluered(100), key=FALSE, 
          cexRow = 0.65, cexCol = 0.8, margins = c(5, 5),
          trace = "none", density.info = "none")

# male
topic.male <- tbl_df(hm_corpus_df) %>%
  filter(gender %in% c("m")) %>%
  select(age, Food:Shopping) %>%
  group_by(age) %>%
  summarise_all(funs(mean))
topic.male <- as.data.frame(topic.male)
rownames(topic.male) <- topic.male[,1]

heatmap.2(as.matrix(topic.male[,topic.plot+1]), 
          scale = "column", dendrogram = "none", Rowv=FALSE, Colv=FALSE,
          col = bluered(100), key=FALSE, 
          cexRow = 0.65, cexCol = 0.8, margins = c(5, 5),
          trace = "none", density.info = "none")
```

An interesting observation is that, under the age of 45, **Shopping** seems to make men much happier than women. Although we may think women like to shop more than men do, our analysis suggests that, under the age of 45, **Shopping** is a big source of happiness for the male, while the female care more about the emotional connection, such as **People** and **Special Event**.

On the other hand, we can observe that men do not put much weights on **Family** until the age of 40, which is obviously a higher age than women.


## References
1. HappyDB: A Corpus of 100,000 Crowdsourced Happy Moments from https://arxiv.org/pdf/1801.07746.pdf
2. The Effect of Gender and Age on Happiness from https://www.gaiashomes.com/gender-age-happiness/



